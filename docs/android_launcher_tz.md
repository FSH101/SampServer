# Техническое задание: Android-лаунчер для подключения к одному SA-MP/open.mp серверу

**Проект:** Android-лаунчер для подключения только к одному SA-MP/open.mp серверу  
**Дата:** 2025-11-07  
**Версия ТЗ:** 1.0  
**Заказчик:** Денис  
**Целевой сервер:** `141.95.190.144:1453` (фиксировано, без выбора других серверов)

---
## 1. Цель
Создать мобильный лаунчер (Android APK), который:
- подготавливает среду клиента GTA:SA Mobile/SA-MP Mobile;
- проверяет и обновляет сторонние ресурсы (мод-пак, аудио, модели, карты);
- запускает установленный мобильный SA-MP клиент и автоматически соединяется **только** с сервером `141.95.190.144:1453`;
- работает без root-прав и публикуется как отдельное приложение (допускается размещение вне Play Store).

---
## 2. Контекст и совместимость
- Сервер — open.mp/SA-MP 0.3.7-совместимый. Клиентская часть — существующие SA-MP Mobile клиенты (неофициальные) либо их форк.
- Лаунчер **не является** игровым движком. Он готовит ресурсы и передает параметры выбранному мобильному клиенту.
- Требуемая совместимость: Android 8.0 (SDK 26) и выше, с особым вниманием к Android 11+ (Scoped Storage).

---
## 3. Архитектура решения
### Вариант A (обязателен)
1. Лаунчер скачивает/обновляет сторонние ресурсы по манифесту (см. §6).
2. Лаунчер записывает ник, хост и порт в ini-файлы клиента через SAF (без `MANAGE_EXTERNAL_STORAGE`):
   - `SAMP/settings.ini` → `name=...` (ник игрока)
   - `mod_sa/sets.ini` → `host=141.95.190.144`, `port=1453`, `password=` (опционально)
3. Лаунчер запускает установленный клиент через PackageManager/Intent.
4. Клиент открывается и сразу подключается к целевому серверу.
5. Если клиент не установлен — показывается экран с инструкцией и кнопками «Открыть страницу клиента» (маркет/сайт).

### Вариант B (опционально, может быть реализован вторым этапом)
- Реализовать обработку deep-link вида `samp://141.95.190.144:1453?nick=...&pwd=...` во форке клиента.
- Лаунчер вызывает deep-link, клиент самостоятельно вносит параметры и подключается.
- Преимущества: отсутствие записи во внешние папки/ini, улучшенный UX на Android 11+.
- Недостатки: необходимость поддержки собственного форка клиента.

---
## 4. Поддерживаемые пакеты клиентов (вариант A)
Лаунчер должен пытаться найти и запустить один из известных пакетов (порядок проверки настраиваемый):
- `ru.unisamp_mobile.launcher`
- `ro.alyn_sampmobile.launcher`
- `com.samp.client`
- `com.samp.mobile`

Если ни один не найден — показывается экран «Клиент не установлен» с инструкцией.

---
## 5. Права и доступы Android
- SAF (Storage Access Framework): при первом запуске запросить доступ к каталогу GTA/SA-MP клиента `Android/obb/com.rockstargames.gtasa/files/`.
- Ожидаемая структура:
  ```
  Android/obb/com.rockstargames.gtasa/files/
  ├─ SAMP/settings.ini
  └─ mod_sa/sets.ini
     ├─ mod_sa/models/
     ├─ mod_sa/audio/
     └─ ...
  ```
- Разрешения: `INTERNET` (загрузка манифеста и файлов). `REQUEST_INSTALL_PACKAGES` не требуется. `MANAGE_EXTERNAL_STORAGE` запрещено.

---
## 6. Ресурс-менеджер
- Все сторонние файлы задаются единственным JSON-манифестом по HTTPS.
- Обязательные функции:
  - загрузка `manifest.json`;
  - сравнение локальной версии с версией из манифеста;
  - скачивание только изменившихся файлов;
  - проверка SHA-256 для каждого файла;
  - распаковка zip-пакетов (если `file.type = "zip"`) в указанный `dest`;
  - ведение локального индекса `installed.json` с актуальными хэшами;
  - кнопка «Починить» — принудительная переустановка несоответствующих файлов.

### Формат manifest.json (пример)
```json
{
  "version": "2025.11.08-01",
  "minClient": "0.3.7",
  "files": [
    {
      "url": "https://cdn.example.com/modpack/models/player.dff",
      "dest": "mod_sa/models/player.dff",
      "sha256": "e3b0c44298fc1c149afbf4c8996fb924...",
      "size": 123456
    },
    {
      "url": "https://cdn.example.com/audio/ui_click.wav",
      "dest": "mod_sa/audio/ui_click.wav",
      "sha256": "5f70bf18a08660b1c...f2d",
      "size": 23456
    },
    {
      "url": "https://cdn.example.com/packs/hd_textures.zip",
      "dest": "mod_sa/",
      "sha256": "a9b9f04336ce0181...",
      "size": 532145,
      "type": "zip",
      "unpackTo": "mod_sa/"
    }
  ]
}
```

### Правила путей и обработка ошибок
- `dest` трактуется относительно каталога `Android/obb/com.rockstargames.gtasa/files/`.
- Запрещается записывать выше указанной папки; допускается создание недостающих директорий.
- Скачивание должно повторяться при временных ошибках (5xx, проблемы сети).
- Проверять таймауты и свободное место на устройстве.
- Атомарная запись: скачивать во временный файл → сверять SHA-256 → переименовывать.

---
## 7. Экранные требования и UX
Минимальный набор экранов:
1. **Главный экран**
   - Лого проекта, статус ресурсов (ОК/есть обновления/ошибка).
   - Кнопки: «Играть», «Ресурсы», «Настройки».
   - Подвал с IP сервера `141.95.190.144:1453`.
2. **Ресурсы**
   - Кнопка «Проверить обновления».
   - Список загружаемых файлов, прогресс, скорость, итог.
   - Кнопка «Починить файлы».
3. **Настройки**
   - Поле для никнейма.
   - Поле для пароля (опционально; сохраняется в `sets.ini` или передается через deep-link во варианте B).
   - Выбор папки клиента (повторный выбор SAF).
   - Переключатель «Автозапуск клиента после обновления ресурсов» (включен по умолчанию).
4. **Нет клиента**
   - Объяснение поддерживаемых клиентов.
   - Кнопки «Открыть страницу клиента» (маркет/сайт) и «Повторить проверку».

Требования к UI: темная тема по умолчанию, адаптивная верстка. Локализации: RU (обязательно), EN (желательно).

---
## 8. Константы конфигурации
```kotlin
const val SERVER_HOST = "141.95.190.144"
const val SERVER_PORT = 1453
const val MANIFEST_URL = "<выдать при интеграции CDN>"
val SUPPORTED_PACKAGES = listOf(
    "ru.unisamp_mobile.launcher",
    "ro.alyn_sampmobile.launcher",
    "com.samp.client",
    "com.samp.mobile"
)
const val SAMP_SETTINGS_REL = "SAMP/settings.ini"
const val SAMP_MODSA_SETTINGS_REL = "mod_sa/sets.ini"
```

---
## 9. Инъекция параметров в ini (вариант A)
- `SAMP/settings.ini`: `name={{NICK}}`
- `mod_sa/sets.ini`: `host=141.95.190.144`, `port=1453`, `password={{PASSWORD}}` (если пароль пустой — строку можно не писать).

Правка ini через SAF:
1. Найти выбранную пользователем директорию `DocumentTree` → построить `DocumentFile` для нужного пути.
2. Читать/писать потоками UTF-8.
3. Создавать резервные копии: `settings.ini.bak`, `sets.ini.bak`.

---
## 10. Запуск клиента (вариант A)
- Перебирать `SUPPORTED_PACKAGES`, проверяя наличие каждого пакета через `PackageManager`.
- При обнаружении — запускать `Intent` с `ACTION_MAIN` и `CATEGORY_LAUNCHER`, флаг `FLAG_ACTIVITY_NEW_TASK`.
- Если клиенты не найдены — показывать экран «Нет клиента».
- После успешного запуска клиента лаунчер сворачивается (`finish()`).

---
## 11. CI/CD и сборка
- Репозиторий: GitHub.
- CI: GitHub Actions — задача `assembleDebug` всегда; `assembleRelease` при наличии секретов подписи.
  - Секреты: `ANDROID_KEYSTORE_BASE64`, `ANDROID_KEYSTORE_PASSWORD`, `ANDROID_KEY_ALIAS`, `ANDROID_KEY_PASSWORD`.
- Артефакты: выгружать APK (debug/release) как artifacts.
- Минимальная версия инструментов: AGP/JDK — JDK 17; при использовании старых NDK предусмотреть профиль «legacy».

---
## 12. Технологии
- Язык: Kotlin, UI — Jetpack Compose.
- HTTP: OkHttp/Retrofit.
- JSON: `kotlinx.serialization` или Moshi.
- Хэши: `MessageDigest` (SHA-256).
- SAF: `androidx.documentfile.provider.DocumentFile`.
- Логирование: Timber или стандартный Log + лог-файл в приватном хранилище; экран «Поделиться логом».

---
## 13. Безопасность
- Все загрузки только по HTTPS.
- Проверка SHA-256 обязательна для каждого файла.
- Отсутствие привилегированных разрешений.
- Конфиденциальные поля (пароль) хранить в `SharedPreferences` (желательно `EncryptedSharedPreferences` для публикации в Play Store).

---
## 14. Тест-план
Устройства/версии Android: 10, 11, 13 (по одному устройству на версию).

Сценарии:
1. Первый запуск: запрос SAF → выбор корректной папки → проверка/скачивание ресурсов → «Играть» → клиент стартует.
2. Повторный запуск: обновлений нет → «Играть» работает мгновенно.
3. Потеря сети во время скачивания: корректные ретраи и сообщения.
4. Поврежденный файл (несовпадение хэша): «Починить» восстанавливает.
5. Нет клиента: корректный экран и переход в маркет/на сайт.
6. Смена ника/пароля: ini обновлены; клиент подключается к `141.95.190.144:1453`.
7. Android 11+: работа только через SAF; без падений/ANR.

Критерии приемки:
- Из «чистого» состояния пользователь за ≤ 5 действий получает «Играть» и входит на сервер `141.95.190.144:1453`.
- Все файлы из манифеста присутствуют и совпадают по SHA-256.
- Логи ошибок читаемы, их можно отправить разработчику одним действием.
- Нет обращения к сторонним серверам, кроме `MANIFEST_URL`/CDN и установки клиента.

---
## 15. Ограничения и риски
- Поведение мобильных SA-MP клиентов может отличаться (рендер TextDraw/Objects и т. п.).
- Доступ к `/Android/obb/...` возможен только через SAF → требуется разовый выбор папки пользователем.
- Некоторые клиенты могут не поддерживать автоконнект через ini — потребуется тестирование или переход к варианту B (deep-link).
- Лаунчер не вмешивается в механику игры; античиты и мод-лоадеры — на стороне клиента/сервера.

---
## 16. Лицензии и сторонние библиотеки
- В README перечислить все используемые библиотеки и их лицензии.
- Ответственность за сторонние мобильные клиенты/ресурсы несет владелец сборки.

---
## 17. Доставляемые артефакты
- Исходный код лаунчера (GitHub).
- CI-workflow (GitHub Actions).
- APK: debug и release.
- README с инструкцией по сборке и настройке `MANIFEST_URL`/CDN.
- Для варианта B — форк клиента с поддержкой `samp://` и инструкцией сборки.

---
## 18. Дальнейшие улучшения (по желанию)
- Автоматическая диагностика распространенных проблем (некорректная папка SAF, нехватка места).
- Телеметрия без персональных данных (количество успешных подключений, скорость загрузки ресурсов) — с возможностью отключения.
- Встроенный новостной экран (JSON-лента).
- Проверка версии сервера/объявлений (MOTD).

---
**Конец ТЗ.**
